{% extends 'base.html' %}
{% block title %}ALX Syllabus Archiver{% endblock title %}
{% block content %}
<h1>ALX Project Syllabus Archiver</h1>
<h4>Access your ALX profile and download the project syllabus in zipped format for offline reference!</h4>
<hr>
<form action="{{url_for('alx_scrape_view.archive_page')}}" method="POST">
    <label for="custom-cookie">Custom Cookie: </label>
    <input id="custom-cookie" type="text" name="custom-cookie">
    <button class="clear btn" type="button">Clear</button>
    <br>
    <input class="fetch btn" type="submit" value="Fetch ALX Projects">
</form>

    {% if status == "1" %}
        <a class="download-link alx-zip" href="/download/{{zip_path}}">Download Your Alx Syllabus!</a>
    {% endif %}

<script>
    body = document.querySelector("body");
    body.style.backgroundColor = "yellow";

    const clearBtn = document.querySelector(".clear.btn");
    clearBtn.addEventListener("click", () => {
        document.querySelector("#custom-cookie").value = "";
    });

    fetchBtn = document.querySelector(".fetch.btn");
    //fetchBtn.addEventListener("click", () => {
    //    body.style.backgroundColor = "pink";
    //    screenSaver();
    //});

    let linkGotten = false;

    const localUrl = "http://127.0.0.1:5000/alx_syllabus_archiver/status";
    const remoteUrl = "https://alx-archiver.herokuapp.com/alx_syllabus_archiver/status";

    let responseTimer, colorEffectTimer;

    function processResponse(url=localUrl) {
        const xhr = new XMLHttpRequest; // create the request object
        xhr.open("GET", url); // opens for configuration but doesn't send request yet
    
        xhr.responseType = "json"; //optional but sets response type as json instead of text
        // xhr.responseType = "document";
    
        // DO THIS to access the response. It can only be accessed in the onload event.
        xhr.onload = () => {
            //console.log(xhr.response);
            if (xhr.response == null)
            {
                status = null;
            }
            else
            {
                status = xhr.response["status"];
            }
            console.log(status);
            if (status == "0"){ // fetching in progress
                let display = document.querySelector("h3.screen-saver");
                if (display == null){
                    display = document.createElement("h3");
                    display.textContent = "Fetching ALX Projects. Should take just about 5 minutes."
                    display.className = "screen-saver"
                    document.body.appendChild(display);

                    const colors = ["pink", "green", "orange", "cyan", "magenta", "purple"];

                    colorEffectTimer = setInterval(
                        () => {
                            display.style.color = colors[Math.round(Math.random() * colors.length)]
                        }, 700
                    );
                }                
            }
            else if (status == "1"){ // fetching successfully completed
                let display = document.querySelector("h3.screen-saver");
                if (display != null){
                    location.reload();
                }
                else{
                    linkGotten = true;
                }  
            }
            else if (status == "-1"){ // fetching failed
                let display = document.querySelector("h3.screen-saver");
                if (display == null){
                    display = document.createElement("h3");
                    display.className = "screen-saver"
                    document.body.appendChild(display);
                }
                display.textContent = "Error occured. Ensure custom cookie is valid!";
                display.style.color = "red";
                clearInterval(colorEffectTimer);
                clearInterval(responseTimer);
            }
            
        };
    
        xhr.send(); // actually send the request
    }

    if (linkGotten == false){
        processResponse();
    } 
    
    responseTimer = setInterval(
        () => {
            if (linkGotten == false){
                processResponse();
            }            
        },
        5000
    );
    
         
</script>
{% endblock content %}