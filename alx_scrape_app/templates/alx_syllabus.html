{% extends 'base.html' %}
{% block title %}ALX Syllabus Archiver{% endblock title %}
{% block content %}
<h1>ALX Project Syllabus Archiver</h1>
<h4>Access your ALX profile and download the project syllabus in zipped format for offline reference!</h4>
<hr>
<form action="{{url_for('alx_scrape_view.archive_page')}}" method="POST">
    <input class="fetch btn" type="submit" value="Fetch ALX Projects">
</form>

    {% if status == "1" %}
        <a class="download-link alx-zip" href="/download/{{zip_path}}">Download Your Alx Syllabus!</a>
    {% endif %}

<script>
    body = document.querySelector("body");
    body.style.backgroundColor = "yellow";

    fetch_btn = document.querySelector(".fetch.btn");
    //fetch_btn.addEventListener("click", () => {
    //    body.style.backgroundColor = "pink";
    //    screenSaver();
    //});

    let linkGotten = false;

    const localUrl = "http://127.0.0.1:5000/alx_syllabus_archiver/status";
    const remoteUrl = "https://alx-archiver.herokuapp.com/alx_syllabus_archiver/status";

    function processResponse(url=remoteUrl) {
        const xhr = new XMLHttpRequest; // create the request object
        xhr.open("GET", url); // opens for configuration but doesn't send request yet
    
        xhr.responseType = "json"; //optional but sets response type as json instead of text
        // xhr.responseType = "document";
    
        // DO THIS to access the response. It can only be accessed in the onload event.
        xhr.onload = () => {
            //console.log(xhr.response);
            if (xhr.response == null)
            {
                status = null;
            }
            else
            {
                status = xhr.response["status"];
            }
            console.log(status);
            if (status == "0"){
                let display = document.querySelector("h3.screen-saver");
                if (display == null){
                    display = document.createElement("h3");
                    display.textContent = "Fetching ALX Projects. Should take less than 5 minutes."
                    display.className = "screen-saver"
                    document.body.appendChild(display);

                    const colors = ["pink", "green", "orange", "cyan", "magenta", "purple"];

                    setInterval(
                        () => {
                            display.style.color = colors[Math.round(Math.random() * colors.length)]
                        }, 700
                    );
                }                
            }
            else if (status == "1"){
                let display = document.querySelector("h3.screen-saver");
                if (display != null){
                    location.reload();
                }
                else{
                    linkGotten = true;
                }  
            }
            
        };
    
        xhr.send(); // actually send the request
    }

    if (linkGotten == false){
        processResponse();
    } 
    
    let responseTimer = setInterval(
        () => {
            if (linkGotten == false){
                processResponse();
            }            
        },
        5000
    );
    
         
</script>
{% endblock content %}